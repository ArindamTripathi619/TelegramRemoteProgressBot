# Stage 1: Build dependencies
FROM python:3.11-alpine AS builder

WORKDIR /build

# Install build dependencies
RUN apk add --no-cache gcc musl-dev libffi-dev

# Copy requirements
COPY requirements.txt .
COPY requirements-llm-openai.txt .
COPY requirements-llm-anthropic.txt .
COPY requirements-llm-groq.txt .

# Install dependencies into a local directory
# Modify this list to include only the LLM providers you need
RUN pip install --no-cache-dir --target=/install \
    -r requirements.txt \
    -r requirements-llm-openai.txt \
    -r requirements-llm-anthropic.txt \
    -r requirements-llm-groq.txt

# Stage 2: Runtime
FROM python:3.11-alpine

WORKDIR /app

# Create non-root user
RUN adduser -D botmonitor

# Copy installed dependencies
COPY --from=builder /install /usr/local/lib/python3.11/site-packages

# Copy application code
COPY src/ ./src/
COPY config/example.yaml ./config/example.yaml

# Set environment
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# Switch to non-root user
USER botmonitor

# Default command
CMD ["python", "-m", "bot_monitor.cli", "run"]
